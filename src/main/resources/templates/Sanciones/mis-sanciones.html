<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mi Historial de Sanciones</title>

    <!-- Fuente & iconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

    <!-- Estilos globales -->
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css" />

    <!-- Fijar tema antes de pintar -->
    <script>
        !function(){
          try{
            const key = 'theme_student';
            const t = localStorage.getItem(key)
              || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
            document.documentElement.setAttribute('data-theme', t);
            document.documentElement.style.colorScheme = t;
          }catch(e){}
        }();
    </script>

    <!-- Estilos específicos -->
    <style>
        .page-wrap{ width:min(1100px,96%); margin-inline:auto; display:grid; gap:16px }
        .user-card .title{font-weight:800; display:flex; align-items:center; gap:10px}
        .notice{
          border:1px solid var(--badge-warn-border);
          background:var(--badge-warn-bg);
          color:var(--badge-warn-text);
          border-radius:14px; padding:12px 14px; display:flex; align-items:center; gap:10px;
        }
        .muted-small{ color:var(--muted); font-size:12px }
        .is-active{ background:linear-gradient(180deg, rgba(245,158,11,.10), rgba(245,158,11,.06)) }
        .ellipsis{ max-width:520px }
        @media (max-width:900px){ .ellipsis{ max-width:340px } }
        @media (max-width:640px){ .ellipsis{ max-width:200px } }

        /* ===== Toolbar ordenada ===== */
        .panel-bar.toolbar{
          display:grid;
          grid-template-columns:auto 1fr auto;
          align-items:center;
          gap:12px;
          padding:12px 16px;
        }
        .chip-link{
          display:inline-flex; align-items:center; gap:8px;
          padding:8px 12px; border-radius:999px; text-decoration:none;
          font-weight:700; color:var(--text); background:var(--panel);
          border:1px solid var(--border-soft); box-shadow:var(--shadow-1);
          transition:transform .15s, box-shadow .2s;
        }
        .chip-link:hover{ transform:translateY(-2px); box-shadow:var(--shadow-2) }
        .chip-link i{ color:var(--primary) }
        .panel-title{ display:flex; flex-direction:column; align-items:flex-start; gap:2px }
        .panel-title-text{
          margin:0; font-weight:800; letter-spacing:.2px;
          font-size:clamp(16px,1.9vw,18px); display:flex; align-items:center; gap:8px;
        }
        .panel-title .meta{ margin:0; color:var(--muted); font-size:12px }
        .actions{ display:flex; align-items:center; gap:8px }
        .actions form{ margin:0 }
        @media (max-width: 760px){
          .panel-bar.toolbar{
            grid-template-columns:1fr;
            text-align:center;
          }
          .panel-title{ align-items:center }
          .actions{ justify-content:center; flex-wrap:wrap }
          .crumbs{ display:flex; justify-content:center }
        }
    </style>
</head>
<body>

<main class="container app-main">

    <!-- Toolbar superior -->
    <section class="panel-bar page-wrap toolbar">
        <!-- Migaja / regreso -->
        <div class="crumbs">
            <a th:href="@{/estudiante/inicio}" class="chip-link">
                <i class="bi bi-house-door"></i>
                <span>Inicio</span>
            </a>
        </div>

        <!-- Título y subtítulo centrados -->
        <div class="panel-title">
            <h1 class="panel-title-text">
                <i class="bi bi-card-checklist"></i> Mi historial de sanciones
            </h1>
            <p class="meta">Resumen y detalle de tus sanciones</p>
        </div>

        <!-- Acciones -->
        <div class="actions">
            <button type="button" id="themeToggle" class="btn btn-ghost theme-toggle" title="Cambiar tema">
                <i class="bi bi-brightness-high sun"></i>
                <i class="bi bi-moon moon"></i>
            </button>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </button>
            </form>
        </div>
    </section>

    <!-- Datos del usuario -->
    <section class="panel-card page-wrap animate-in in" style="--d:.04s" th:if="${usuario}">
        <div class="panel-head"><h3><i class="bi bi-person-circle"></i> Mi perfil</h3></div>
        <div style="padding:16px 18px" class="user-card">
            <div class="title">
                <i class="bi bi-person-badge"></i>
                <span th:text="${usuario.fullName}">Nombre del Estudiante</span>
            </div>
            <p class="muted" style="margin:6px 0 0">
                <strong>Email:</strong> <span th:text="${usuario.email}">email@ejemplo.com</span>
            </p>
        </div>
    </section>

    <!-- KPIs -->
    <section class="page-wrap">
        <div class="stats-grid">
            <div class="kpi-card in">
                <div class="kpi-head">
                    <div class="kpi-icon soft-violet"><i class="bi bi-list-ul"></i></div>
                    <div>
                        <p class="kpi-title">Total sanciones</p>
                        <p class="kpi-sub">Histórico en el sistema</p>
                    </div>
                </div>
                <div class="kpi-value" th:text="${#lists.size(sanciones)}">0</div>
            </div>

            <div class="kpi-card in" style="--d:.03s">
                <div class="kpi-head">
                    <div class="kpi-icon soft-red"><i class="bi bi-exclamation-triangle"></i></div>
                    <div>
                        <p class="kpi-title">Sanciones activas</p>
                        <p class="kpi-sub">Aún sin resolver</p>
                    </div>
                </div>
                <div class="kpi-value" th:text="${#lists.size(sancionesActivas)}">0</div>
            </div>

            <div class="kpi-card in" style="--d:.06s">
                <div class="kpi-head">
                    <div class="kpi-icon soft-blue"><i class="bi bi-check-circle"></i></div>
                    <div>
                        <p class="kpi-title">Resueltas</p>
                        <p class="kpi-sub">Cerradas correctamente</p>
                    </div>
                </div>
                <div class="kpi-value" th:text="${#lists.size(sanciones) - #lists.size(sancionesActivas)}">0</div>
            </div>
        </div>
    </section>

    <!-- Aviso activo -->
    <section class="page-wrap" th:if="${!#lists.isEmpty(sancionesActivas)}">
        <div class="notice">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <div><strong>Atención:</strong> Tienes sanciones activas que pueden afectar tu capacidad para solicitar préstamos.</div>
        </div>
    </section>

    <!-- Tabla -->
    <section class="panel-card page-wrap animate-in in" style="--d:.08s">
        <div class="panel-head">
            <h3><i class="bi bi-table"></i> Historial completo</h3>
        </div>

        <div style="padding:10px 12px">
            <!-- Vacío -->
            <div th:if="${#lists.isEmpty(sanciones)}" style="text-align:center; padding:28px 12px">
                <i class="bi bi-emoji-smile" style="font-size:42px; color:var(--green)"></i>
                <p class="h5" style="margin:10px 0 4px; font-weight:800; color:var(--green)">¡Excelente! No tienes sanciones</p>
                <p class="muted">Mantén este buen comportamiento</p>
            </div>

            <!-- Lista -->
            <div th:if="${!#lists.isEmpty(sanciones)}" class="table-wrap">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Descripción</th>
                        <th>Multa</th>
                        <th>Estado</th>
                        <th>Resolución</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="s : ${sanciones}"
                        th:classappend="${s.isResolved} ? '' : ' is-active'"
                        th:with="t=${s.type},
                       cls=${(t=='Daño físico' || t=='Pérdida de equipo') ? 'danger' :
                             ((t=='Exceso de tiempo' || t=='Mora') ? 'warn' : 'primary')}">
                        <td th:text="${s.createdAt != null ? #temporals.format(s.createdAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">01/01/2024 10:00</td>
                        <td><span class="badge" th:classappend="' ' + ${cls}" th:text="${s.type}">Tipo</span></td>
                        <td class="ellipsis" th:text="${s.description}">Descripción…</td>
                        <td>
              <span th:if="${s.fineAmount != null and s.fineAmount > 0}" class="badge danger">
                $<span th:text="${#numbers.formatDecimal(s.fineAmount, 1, 2)}">0.00</span>
              </span>
                            <span th:unless="${s.fineAmount != null and s.fineAmount > 0}" class="muted">Sin multa</span>
                        </td>
                        <td>
              <span th:if="${s.isResolved}" class="badge success">
                <i class="bi bi-check-circle"></i> Resuelta
              </span>
                            <span th:unless="${s.isResolved}" class="badge warn">
                <i class="bi bi-exclamation-triangle"></i> Activa
              </span>
                        </td>
                        <td th:text="${s.resolvedAt != null ? #temporals.format(s.resolvedAt, 'dd/MM/yyyy HH:mm') : '-'}">-</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Información adicional -->
    <section class="panel-card page-wrap animate-in in" style="--d:.1s">
        <div class="panel-head">
            <h3><i class="bi bi-info-circle"></i> Información importante</h3>
        </div>
        <div style="padding:16px 18px">
            <ul style="margin:0; padding-left:18px">
                <li><strong>Sanciones activas:</strong> pueden limitar tu acceso a préstamos de equipos.</li>
                <li><strong>Multas:</strong> deben ser pagadas para resolver la sanción.</li>
                <li><strong>Contacto:</strong> si tienes dudas, comunícate con el administrador.</li>
                <li><strong>Prevención:</strong> cuida los equipos y respeta los tiempos de devolución.</li>
            </ul>
            <p class="muted-small" style="margin-top:10px">Última actualización:
                <span th:text="${#dates.format(#dates.createNow(),'dd/MM/yyyy HH:mm')}">hoy</span>
            </p>
        </div>
    </section>

</main>

<footer class="app-footer container">
    <span>© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> LapSync</span>
    <span class="muted">Área de estudiante</span>
</footer>

<!-- Toggle de tema -->
<script>
    (function(){
      const btn = document.getElementById('themeToggle');
      if(!btn) return;
      btn.addEventListener('click', function(){
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        root.style.colorScheme = next;
        try{ localStorage.setItem('theme', next); }catch(e){}
      });
    })();
</script>

</body>
</html>
